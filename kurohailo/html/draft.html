<!DOCTYPE html>

<html>
<head>
    <title>Tile Planer</title>
    <link rel="stylesheet" href="css/draft.css">
    <script src="scripts/jquery-1.11.3.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
</head>
<body>
    <div id="clickClickMenu"></div>
    <div id="editPromt">
        <div id="editHeader"></div>
        <input id="editPromtInput" type="text">
        <input class="clearLeft" type="button" value="accept" onclick=acceptEdit()>
        <input type="button" value="cancel" onclick=cancelEdit()>
    </div>
    <div id="morePanel">
        <div id="moreHeader"><div class="close"></div></div>
        <div id="legend_desc">
            <div class="color_square started"></div><div class="legend_label">stated</div>
            <div class="color_square done"></div><div class="legend_label">done</div>
            <div class="color_square issues"></div><div class="legend_label">issues</div>
            <div class="color_square default"></div><div class="legend_label">default</div>
            <div class="color_square new"></div><div class="legend_label">new</div>
        </div>
        <div id="current_users_desc">
            <div class="color_square" id="USER_1"></div><div class="legend_label">Jens</div>
        </div>
    </div>
    <div id="super_tile">
        <div class="super_label"></div>
        <div id="project_buttons">
            <div class="p_button" id="button_more"><img src="images/more-512.png"></div>
            <div class="p_button" id="button_options"><img src="images/17214.png"></div>
        </div>
    </div>
    <input id="data_version" type="hidden" value='<!--DATA VERSION-->'>
    <input id="crumb_field" type="hidden" value='<!--CRUMB FIELD-->'>
    <input id="data_field" type="hidden" value='<!--DATA FIELD-->'>    
</body>
<script>
    /**
     * UTIL FUNCTIONS
     **/
    function findNode(nID){
        return $("div[nid='" + nID + "']");
    }
    
    class DragState {
        constructor(){
            this.dragStart = null;
            this.dragObj = null;
            this.parentObj = null;
            this.gridDimensions = null;
        }
    }
    
    class TileNode {
        constructor(rawTileNode){
            this.id = rawTileNode.id;
            this.label = rawTileNode.label;
            this.status = rawTileNode.status;
            this.ordering = rawTileNode.ordering;
            
            if (rawTileNode.parent_path.length - 2 >= 0){
                this.parentID = rawTileNode.parent_path[rawTileNode.parent_path.length - 2];
            } else {
                this.parentID = null;
            }
            
            this.parentPath = rawTileNode.parent_path;
        }
    }
    
    class TileState {
        constructor(){
            const urlComp = window.location.href.split("/");
            const rawIDs = urlComp[urlComp.length - 1];
            const rawSplitList = rawIDs.split("_");
            
            if (rawSplitList.length == 2){
                this.PID = parseInt(rawSplitList[0]);
                this.parentTileID = parseInt(rawSplitList[1]);
            } else {
                this.PID = parseInt(rawSplitList[0]);
                this.parentTileID = 1;
            }
            this.tileLookup = {};
            this.tileChildren = {};
            this.selectedTileIDList = [];
        }
        
        /* TILE FUNCS */
        getTile(tileID){
            return this.tileLookup[tileID];
        }
        
        setTile(tileData){
            const tileNode = new TileNode(tileData);
            this.tileLookup[tileData.id] = tileNode;
            this.tileChildren[tileData.id] = [];
            
            if (tileNode.parentID !== null){
                const parentChildList = TS.getTileChildren(tileNode.parentID);
                
                if (parentChildList){
                    parentChildList.push([tileData.id, tileData.ordering]);
                
                    //TODO: OPTIMIZE BETTER INIT SORT
                    parentChildList.sort(function(a,b){
                        return a[1] - b[1];
                    });
                }
            }
        }
        
        removeCachedTile(tileID){
            delete this.tileLookup[tileID];
            delete this.tileChildren[tileID]; 
        }
        
        /* TILE CHILDREN FUNCS */
        getTileChildren(parentTileID){
            return this.tileChildren[parentTileID];
        }
        
        /* SELECTION */
        getSelectionList(){
            return this.selectedTileIDList;
        }
        
        removeTileFromSelection(tile) {
            const tileID = tile.attr("nid");
            selectedTileIDList.splice(selectedTileIDList.indexOf(tileID), 1);
            tile.removeClass("selected");
        }
        
        addTileToSelection(tile) {
            const tileID = tile.attr("nid");
            tile.addClass("selected");
            this.selectedTileIDList.push(tileID);
        }
        
        resetSelectedTiles() {
            while (this.selectedTileIDList.length > 0){
                const cID = this.selectedTileIDList.shift();
                const targetTile = findNode(cID);
                targetTile.removeClass("selected");
            }
        }
    }
    
    var origin = null;
    var editType = null;
    
    var TS = new TileState();
    
    //var nodeLookup = {};
    var nodeChildren = {};
    var selectedNodes = [];
    
    function removeAjax(targetID, succesFunc) {
        $.ajax({
            type: "POST",
            url: "update/" + TS.PID,
            data: {"change_type":"remove",
                   "data": JSON.stringify({"node_id": targetID})},
            success: succesFunc,
            dataType: "json"
        });
    }
    
    
    
    function removeTile(originID, reload=false) {
        const target = TS.getTile(originID);
        
        if (target === undefined){
            return;
        }
        
        const targetChildList = TS.getTileChildren(originID);
        while (targetChildList.length > 0){
            childTargetID = targetChildList.shift();
            removeTile(childTargetID);
        }
        
        success = function(){
            if (target.parent_path.length > 1){
                closestParentID = target.parent_path[target.parent_path.length - 2];
                closestParentChildList = TS.getTileChildren(closestParentID);
                
                const idIndex = parseInt(originID);
                if (idIndex !== undefined){
                    closestParentChildList.splice(closestParentChildList.indexOf(idIndex), 1);
                }
            }
            
            TS.removeCachedTile(originID);
            
            if (reload){
                loadData();
            }
        };
        
        removeAjax(originID, success);
    }
    
    function acceptEdit(){
        editPromt = $("#editPromt");
        originID = origin.attr("nid");
        
        if (editType == "rename"){
            inputField = editPromt.children("input:text");
            newLabel = inputField.val();
            
            dataComponent = JSON.stringify({
                "node_id_list": [originID],
                "label": newLabel
            });
            
            $.ajax({
                type: "POST",
                url: "update/" + TS.PID,
                data: {
                    "change_type":"modify",
                    "data": dataComponent
                    },
                success: function(){
                    targetTile = TS.getTile(originID);
                    targetTile.label = newLabel;
                    loadData();
                },
                dataType: "json"
            });
        } else if (editType == "remove"){
            const selectionList = TS.getSelectionList();
            for (let i = 0; i < selectionList.length; i++){
                const cID = selectionList[i];
                removeTile(cID, true);
            }
            
        } else if (editType == "add"){
            inputField = editPromt.children("input:text");
            newLabel = inputField.val();
            
            $.ajax({
                type: "POST",
                url: "update/" + TS.PID,
                data: {"change_type":"add",
                       "data": JSON.stringify({"parent_id": originID,
                                               "label": newLabel})},
                success: function(response){
                    newNodeID = response.id;
                    ordering = response.ordering;
                    
                    TS.setTile(response);
                    loadData();
                },
                dataType: "json"
            });
        }
        
        origin = null;
        editType = null;
        editPromt.css("display", "None");
    }
    
    function cancelEdit(){
        origin = null;
        editType = null;
        editPromt = $("#editPromt");
        editPromt.css("display", "None");
    }
    
    function zoom(origin){
        const urlComp = window.location.href;
        originID = origin.attr("nid");
        
        rightClickMenu = $("#clickClickMenu");
        rightClickMenu.css("display", "none");
        
        window.location.href = urlComp.split("_")[0] + "_" + originID;
    }
    
    function reorderFunc(){
        //TODO make a drag and drop that calcs the grid pos index on release
        gridPosIndex = 0;
        
        //TODO get selected tile reorder siblings accordingly
        //TODO make a combined update call of new sibling order
        
        
        
        const selectedTileIDList = TS.getSelectionList();
        
        for (let i = 0; i < selectedTileIDList.length; i++){
            const cID = selectedTileIDList[i];
            
            console.log(cID);
        }
        
        rightClickMenu = $("#clickClickMenu");
        rightClickMenu.css("display", "none");
    }
    
    function addFunc(originBlock){
        origin = originBlock;
        editType = "add";
        
        rightClickMenu = $("#clickClickMenu");
        rightClickMenu.css("display", "none");
        
        showEditPromt();
    }
    
    function renameFunc(originBlock){
        origin = originBlock;
        editType = "rename";
        
        rightClickMenu = $("#clickClickMenu");
        rightClickMenu.css("display", "none");
        
        showEditPromt();
    }
    
    function removeFunc(originBlock){
        origin = originBlock;
        editType = "remove";
        
        rightClickMenu = $("#clickClickMenu");
        rightClickMenu.css("display", "none");
        
        showEditPromt();
    }
    
    
    function showEditPromt(){
        editPromt = $("#editPromt");
        editHeader = $("#editHeader");
        editInput = $("#editPromtInput");
        
        if (editType == "rename"){
            editHeader.text("Rename");
            editInput.show();
            
            if (origin.is("#super_tile")){
                originLabelNode = origin.children(".super_label");
            } else {
                originLabelNode = origin.children(".block_label");
            }
            originLabel = originLabelNode.text();
            editInput.val(originLabel);
        } else if (editType == "remove"){
            editHeader.text("Are you sure you want to remove?");
            editInput.hide();
        } else {
            editHeader.text("Add");
            editInput.show();
            editInput.val("");
        }
        
        editPromt.css("display", "block");
        editInput.focus();
    }
    
    function changeStatus(event, newStatus){
        rightClickMenu = $("#clickClickMenu");
        rightClickMenu.css("display", "none");
        
        let classString = "block regular_block selected";
        if (newStatus === 0){
            classString = classString + " new";
        } else if (newStatus === 1){
            classString = classString + " default";
        } else if (newStatus === 2){
            classString = classString + " started";
        } else if (newStatus === 3){
            classString = classString + " issues";
        } else if (newStatus === 4){
            classString = classString + " done";
        }
        
        dataComponent = JSON.stringify({
            "node_id_list": TS.getSelectionList(),
            "status": newStatus
        });
        
        $.ajax({
            type: "POST",
            url: "update/" + TS.PID,
            data: {"change_type":"modify",
                   "data": dataComponent
                   },
            success: function(){
                const selectionList = TS.getSelectionList();
                
                for (let i = 0; i < selectionList.length; i++){
                    const tileID = selectionList[i];
                    const targetTileLookup = TS.getTile(tileID);
                    targetTileLookup.status = newStatus;
                    const targetTile = findNode(tileID);
                    targetTile.attr("class", classString);    
                }                
            },
            dataType: "json"
        });
    }
    
    function leftClickTile(event, origin){
        originLabelNode = origin.children(".block_label");
        //console.log(originLabelNode.text());
        
        if (event.shiftKey) {
            TS.addTileToSelection(origin);
        } else if (event.ctrlKey) {
            if (origin.hasClass("selected")){
                TS.removeTileFromSelection(origin);
            } else {
                TS.addTileToSelection(origin);
            }
        } else {
            TS.resetSelectedTiles();
            TS.addTileToSelection(origin);
        }
    }
    
    function showDropdown(event, origin){
        if( origin.hasClass("selected") === false){
            TS.resetSelectedTiles();
            if (origin.hasClass("block")){
                TS.addTileToSelection(origin);
            }
        } 
        
        leftPos = event.clientX;
        topPos = event.clientY;
        
        rightClickMenu = $("#clickClickMenu");
        
        if (rightClickMenu.css("display") != "block"){
            rightClickMenu.css("display", "block");
        }
        
        rightClickMenu.empty();
        if (origin.hasClass("block")){
            /* BLOCK DROPDOWN */
            contentList = [["Status", "Header"],
                           ["started", function (event){changeStatus(event, 2);}],
                           ["done", function (event){changeStatus(event, 4);}],                                                      
                           ["issues", function (event){changeStatus(event, 3);}],
                           ["default", function (event){changeStatus(event, 1);}],
                           
                           ["Modify", "Header"],
                           ["zoom", function (){zoom(origin);}],
                           ["add", function (){addFunc(origin);}],
                           ["rename", function (){renameFunc(origin);}],
                           ["remove", function (){removeFunc(origin);}],
                           ["reorder", function (){reorderFunc();}]];
        } else {
            /* SUPER BLOCK DROPDOWN */
            contentList = [["Modify", "Header"],
                           ["add", function (){addFunc(origin);}],
                           ["rename", function (){renameFunc(origin);}],
                           ["debug", function (){console.log("ged");}]];
        }
        
        for (let i = 0; i < contentList.length; i++){
            menuLabel = contentList[i][0];
            menuData = contentList[i][1];
            
            if (menuData == "Header"){
                menuNode = $('<div class="menuHeader">' + menuLabel + '</div>');
            } else {
                menuNode = $('<div class="menuButton">' + menuLabel + '</div>');
                menuNode.bind("click", menuData);
            }
            
            rightClickMenu.append(menuNode);    
        }
        
        superTile = $("#super_tile");
        let rightMostX = leftPos + rightClickMenu.width() + 2;
        let parentSizeX = superTile.width();
        
        if (rightMostX > parentSizeX){
            offsetX = rightMostX - parentSizeX;
            leftPos = leftPos - offsetX;
        }
        
        let bottomMostY = topPos + rightClickMenu.height() + 2;
        let parentSizeY = superTile.height();
        
        if (bottomMostY > parentSizeY){
            offsetY = bottomMostY - parentSizeY;
            topPos = topPos - offsetY;
        }
        
        rightClickMenu.css("left", leftPos);
        rightClickMenu.css("top", topPos);
    }
    
    function resizeLayout(){
        windowWidth = window.innerWidth;
        windowHeight = window.innerHeight;
        
        superBlock = $("#super_tile");
        //superBlock.width(windowWidth - 1);
        superBlock.height(windowHeight - 1);
        
        let editMargin = 40;
        let editPadding = 20;
        editPromt = $("#editPromt");
        editPromt.width(windowWidth - editMargin * 2 - editPadding * 2);
        
        let moreWidthSize = 178;
        morePanel = $("#morePanel");
        morePanel.css("left", windowWidth - 180);
        morePanel.width(moreWidthSize);
    }
    
    function initTP(){
        dataVersion = $('#data_version').val();
        
        if (dataVersion == "1"){
            rawCrumbField = $('#crumb_field').val();
            dataList = JSON.parse(rawCrumbField);
            for (let i=0; i<dataList.length; i++){
                TS.setTile(dataList[i]);              
            }
            
            rawDataField = $('#data_field').val();
            dataList = JSON.parse(rawDataField);
            dataList.sort(function(a, b){
                return a.parent_path.length - b.parent_path.length;
            });
            
            for (let i=0; i<dataList.length; i++){
                TS.setTile(dataList[i]);
            }
        }
    }
    
    function loadData(){
        var renderTileQueue = [];
        
        dataVersion = $('#data_version').val();
    
        /* NEW VERSION */
        superTile = $("#super_tile");
        superTile.bind("contextmenu", function(event) {
            showDropdown(event, $(this));
            
            event.preventDefault();
            event.stopPropagation();
        });
        superTile.bind("mousedown", function(event) {
            if (event.which != 3){
                rightClickMenu = $("#clickClickMenu");
                rightClickMenu.css("display", "none");
            }
            
            TS.resetSelectedTiles();
            
            event.stopPropagation();
        });
        
        /* EMPTY OLD DATA */
        superTile.children('div').each(
            function(){
                if ($(this).hasClass("block")){
                        this.remove();
                }
            }
        );
        
        /* LOAD PARENT TILE */
        parentNode = TS.getTile(TS.parentTileID);
        parentPath = parentNode.parentPath;
        
        superTileLabelNode = superTile.children(".super_label");
        parentLabelNodeList = [];
        for (let i = 0; i < parentPath.length; i++){
            let curPathID = parentPath[i];
            const curTile = TS.getTile(curPathID);
            crumbNode = $('<a href="/' + TS.PID + '_' + curTile.id + '" class="crumbLink">' + curTile.label + '</div>');
            
            parentLabelNodeList.push(crumbNode);
            if (i + 1 != parentPath.length){
                parentLabelNodeList.push(" / ");
            }
        }
        
        parentLabel = parentNode.label;
        
        superTileLabelNode.empty();
        superTileLabelNode.append(parentLabelNodeList);
        superTile.attr("nid", TS.parentTileID);
        
        const childrenList = TS.getTileChildren(TS.parentTileID);
        const nrOfSiblings = childrenList.length;
        
        for (let ithElement = 0; ithElement < nrOfSiblings; ithElement++){
            childIDAndOrder = childrenList[ithElement];
            childID = childIDAndOrder[0];
            
            childNode = TS.getTile(childID);
            renderTileQueue.push(childNode);
        }
        
        doSetup = true;
        while (doSetup){
            renderTile = renderTileQueue.shift();
            if (renderTile){
                initBlock(renderTileQueue, renderTile);
            } else {
                doSetup = false;
            }
        }
    }
    
    function initBlock(renderTileQueue, renderTile){
        parentTile = findNode(renderTile.parentID);
        parentWidth = parentTile.width();
        
        if (parentTile.hasClass("small_block")){
            parentHeight = parentTile.height();
        } else if (parentTile.is("#super_tile")){
            parentHeight = parentTile.height() - 40;
        } else {
            parentHeight = parentTile.height() - 20;
        }
        
        nrOfSiblings = TS.getTileChildren(renderTile.parentID).length;
        
        gridDimensions = Math.ceil(Math.sqrt(nrOfSiblings));
        
        col = gridDimensions;
        row = gridDimensions;
        if (parentWidth >= parentHeight){
            if (nrOfSiblings <= col * (row - 1)){
                row = row - 1;
            }    
        } else {
            if (nrOfSiblings <= row * (col - 1)){
                col = col - 1;
            }
        }
        
        let onePxXOffset = false;
        let onePxYOffset = false;
        childSpace = parentWidth / gridDimensions;
        
        if (childSpace < 60){
            isSmallBlock = true;
            usedMargin = 0;
            
            childWidth = parseInt(parentWidth / col);
            childHeight = parseInt(parentHeight / row);
        } else {
            isSmallBlock = false;
            usedMargin = 2;
            
            childWidth = parseInt((parentWidth - (col + 1) * usedMargin) / col);
            childHeight = parseInt((parentHeight - (row + 1) * usedMargin) / row);
        }
                
        if (renderTile.status === 0){
            statusClass = "new";  
        } else if (renderTile.status === 1){
            statusClass = "default";            
        } else if (renderTile.status === 2){
            statusClass = "started";            
        } else if (renderTile.status === 3){
            statusClass = "issues";
        } else if (renderTile.status === 4) {
            statusClass = "done";
        }
        
        if (isSmallBlock){
            injectText = '<div class="block small_block"><div class="block_label hidden_label">' + renderTile.label + '</div></div>';
        } else {
            injectText = '<div class="block regular_block"><div class="block_label">' + renderTile.label + '</div></div>';
        }
        
        nrOFSib = parentTile.children(".block").length;
        
        injectTile = $(injectText);
        parentTile.append(injectTile);
        
        injectTile.attr("nid", renderTile.id);
        injectTile.css("width", childWidth);
        injectTile.css("height", childHeight);
        
        injectTile.css("margin-left", usedMargin);
        injectTile.css("margin-top", usedMargin);
        injectTile.addClass(statusClass);
        
        parentTile.append(injectTile);
        if (!isSmallBlock){
            injectTile.bind("contextmenu", function(event) {
                showDropdown(event, $(this));
                
                event.preventDefault();
                event.stopPropagation();
            });
            injectTile.dblclick(function(event){
                zoom($(this));
                event.stopPropagation();
            });
            
            
            injectTile.bind("mousedown", function(event) {
                if (event.which != 3){
                    rightClickMenu = $("#clickClickMenu");
                    rightClickMenu.css("display", "none");
                }
                
                leftClickTile(event, $(this));
                
                event.preventDefault();
                event.stopPropagation();
            });
            
            injectTile.bind("mouseup", function(event) {
                console.log(event);
                console.log(this);
                event.stopPropagation();
            });
        }
        
        const childrenList = TS.getTileChildren(renderTile.id);
        const nrOfChildSiblings = childrenList.length;
        for (let ithElement = 0; ithElement < nrOfChildSiblings; ithElement++){
            childIDAndOrder = childrenList[ithElement];
            childID = childIDAndOrder[0];
            
            childNode = TS.getTile(childID);
            renderTileQueue.push(childNode);
        }
    }
    
    resizeLayout();
    initTP();
    loadData();
    
    /* BIND GUI AND UTIL FUNCTIONS */
    $("#button_options").bind("click", function(){
        console.log("options");
    });
    
    $("#button_more").bind("click", function(){
        display = $("#morePanel").css("display");
        if (display == "block"){
            $("#morePanel").css("display", "none");
        } else {
            $("#morePanel").css("display", "block");
        }    
    });
    
    $("#morePanel .close").bind("click", function(){
        $("#morePanel").css("display", "none");
    });
    
    window.onresize = function() {
        resizeLayout();
        loadData();
    };
    
    $(window).keypress(function(event){
        if (event.which == 13){
            editPromt = $("#editPromt");
            if (editPromt.css("display") == "block"){
                acceptEdit();
            }
        }
    });
    
    $(window).mousemove(function(event) {
        //console.log(event);
    });
    
    $(window).mouseup(function(event) {
        //console.log(event);
    });

</script>
</html>
